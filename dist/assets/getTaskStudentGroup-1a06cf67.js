import{h as C,b1 as V,b as t,d as D,z as p,o as P,a as c,c as u,D as q,i as d,k as I,F as J,j,K as L,g as b,t as z,f as F,w as y,bc as W,q as $,s as K,x as U,ap as Z,bA as X,_ as Y}from"./index-8f9ccc2f.js";import{s as w}from"./browser-19b77043.js";function he(e,l){return C({url:"/emd_task/task",method:"POST",params:{studentId:e,taskId:l}})}const ee=V("emdLab",{state:()=>({taskId:null,studentId:null,taskName:t(),deviceDataDialog:t(!0),hasNewVal:t(!1),selectedValue:t(),selectedCell:t(),labModelList:t(),emdStudentTask:{},isScrolling:t(!1),showZoomed:t(!1),imageSrc:t(""),currModel:t(),canNextModel:!1}),actions:{setTaskId(e){this.taskId=e},setStudentId(e){this.studentId=e},setTaskName(e){this.taskName=e},setDeviceDataDialog(){this.deviceDataDialog=!this.deviceDataDialog},setHasNewVal(e){this.hasNewVal=e},setSelectedValue(e){this.selectedValue=e},setSelectCell(e){this.selectedCell=e},setLabModelList(e){this.labModelList=e},setEmdStudentTask(e){this.emdStudentTask=e},setimageSrc(e){this.imageSrc=e},setCurrModel(e){this.currModel=e,console.log("currModel-->"),console.log(this.currModel)},setCanNextModel(e){this.canNextModel=e}},getters:{getTaskId:e=>e.taskId,getStudentId:e=>e.studentId,getTaskName:e=>e.taskName,getSelectedValue:e=>e.selectedValue,getCellId:e=>e.selectedCell,getLabModelList:e=>e.labModelList,getEmdStudentTask:e=>e.emdStudentTask,getimageSrc:e=>e.imageSrc,getCurrModel:e=>e.currModel}}),te=V("chat",{state:()=>({assistantChatId:"",changeRightPaneVisible:null,aiRole:"",referenceMaterial:"",sectionPrefix:"",waittingMessage:t(!1),currQuestion:null}),actions:{setAssistantChatId(e){this.assistantChatId=e},setAIRole(e){this.aiRole=e},setReferenceMaterial(e){this.referenceMaterial=e},setSectionPrefix(e){this.sectionPrefix=e},setChangeRightPaneVisible(e){this.changeRightPaneVisible=e},setCurrQuestion(e){this.currQuestion=e}},getters:{getAssistantChatId:e=>e.assistantChatId,getAIRole:e=>e.aiRole,getReferenceMaterial:e=>e.referenceMaterial,getSectionPrefix:e=>e.sectionPrefix,getChangeRightPaneVisible:e=>e.changeRightPaneVisible,getCurrQuestion:e=>e.currQuestion}});const se=["id","innerHTML"],ae=D({__name:"textPreview-small",props:{id:String,content:String},setup(e){const l=e,o=t();return p(()=>l.content,(i,v)=>{i&&(o.value=w.parse(i))}),P(()=>{o.value=w.parse(l.content)}),(i,v)=>(c(),u("div",{id:e.id,innerHTML:o.value},null,8,se))}}),ne={class:"chat-container ist-theam"},le={key:0,class:"h-8 flex flex-row p-1"},oe={key:0,class:L(["message","bot-message"])},ie={key:1,style:{width:"100%","margin-top":"1rem"}},re={style:{width:"100%",height:"3rem"}},ce={style:{width:"100%",display:"flex","justify-content":"center","align-items":"center"}},N=600,ue=D({__name:"aiChat",props:{chatId:{type:String,required:!0}},setup(e){const l=e,o=te();ee();const i=t(),v=t("");t({chatId:l.chatId,sectionPrefix:"",stuInput:"",imgDataurls:[]}),t([]);const n=t(null),g=t([]),k=t(),m=t(!1),x=t(),T=t(),r=t(1),_=t(!0),R=()=>{r.value=1,_.value=!0,S()};t();const E=t(0);p(()=>v.value,s=>{E.value=s.length,s.length>N&&(v.value=s.slice(0,N))});const S=()=>{l.chatId==null||!l.chatId||_.value&&(h(),n.value=new WebSocket("/ai-assistant/"+l.chatId),n.value.onopen=()=>{var s;console.log("start connect to the server"),((s=n.value)==null?void 0:s.readyState)===1&&(x.value=setInterval(()=>{A(n.value)},2e4))},n.value.onmessage=s=>{var f;r.value=1;const a=JSON.parse(s.data);switch(a.type){case"current":g.value=a.current.messages,g.value.reverse();break;case"message-ack":console.log(a),o.waittingMessage=!0,g.value.push(a.payload);break;case"activity-start":o.waittingMessage=!0,m.value=!0,k.value="",o.setChangeRightPaneVisible(!0);break;case"stream":o.waittingMessage=!1,a.kind=="chunk"&&(k.value+=a.payload),a.kind=="final"&&(m.value=!1);break;case"message":g.value.push(a.payload);break;case"activity-stop":m.value=!1,o.waittingMessage=!1;break;case"error":K.error("ai服务断开连接..."),(f=n.value)==null||f.close();break}setTimeout(()=>{i.value.scrollTop=i.value.scrollHeight},10)},n.value.onclose=s=>{if(console.log("Disconnected from the server"),n.value=null,console.log(s),s.code==1001||s.code==1e3){h();return}r.value<3&&(T.value=setTimeout(()=>{S(),r.value++,console.log("ai对话重连"+r.value+"次")},5e3*r.value))},n.value.onerror=()=>{console.log("Error from the ws"),h()})},A=s=>{let a={type:"ping"};s&&s.readyState==1&&s.send(JSON.stringify(a))},h=()=>{n.value&&(n.value.close(),n.value=null),clearInterval(x.value),clearTimeout(T.value)};p(()=>n.value,s=>{var a;console.log("ai-socket-ready->"+((a=n.value)==null?void 0:a.readyState))}),p(()=>r.value,s=>{s>3&&(h(),_.value=!1)});const G=s=>s.role=="user"?"user-message":"bot-message";P(()=>{setTimeout(()=>{S()},10)}),q(()=>{h()}),t({chatId:"",question:null,stuInput:"",sectionPrefix:"",imgDataurls:[]});const O=()=>{const s={type:"stop"};n.value&&n.value.send(JSON.stringify(s))};return(s,a)=>{const f=U,H=Z,Q=X;return c(),u("div",ne,[n.value==null?(c(),u("div",le,[a[0]||(a[0]=d("div",{class:"text-center text-red-500"}," 连接已断开... ",-1)),d("div",{class:"ml-8"},[d("button",{class:"pl-2 pr-2 shadow-md rounded bg-gray-200 hover:bg-gray-400",onClick:R}," 重连 ")])])):I("",!0),d("div",{class:"chat-messages",ref_key:"chatMessages",ref:i},[(c(!0),u(J,null,j(g.value,(M,B)=>(c(),u("div",{key:B,class:L(["message",G(M)])},[b(ae,{id:M.id,content:M.content},null,8,["id","content"])],2))),128)),m.value?(c(),u("div",oe,z(k.value),1)):I("",!0),F(o).waittingMessage?(c(),u("div",ie,[b(H,{placement:"top"},{reference:y(()=>[W(d("div",re,null,512),[[Q,!0]])]),default:y(()=>[d("div",ce,[b(f,{type:"danger",onClick:O},{default:y(()=>a[1]||(a[1]=[$("停止",-1)])),_:1,__:[1]})])]),_:1})])):I("",!0)],512)])}}});const ve=Y(ue,[["__scopeId","data-v-e535e56a"]]);function me(e,l){return C({url:"/ai/st/chat",method:"GET",params:{studentId:e,taskId:l}})}function fe(e,l){return C({url:"pgroup/group/"+e+"/"+l,method:"GET"})}export{me as G,fe as S,te as a,ve as b,he as e,ee as u};
